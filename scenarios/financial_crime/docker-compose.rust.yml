# Alternative docker-compose.yml using Rust sidecar instead of Envoy
# The Panopticon Protocol - High Performance Variant
#
# Use this for maximum performance (lower latency, smaller footprint)
# Envoy version is preferred for production due to ecosystem support

version: '3.8'

services:
  # ====================================================================
  # GREEN AGENT: Python Application (INTERNAL)
  # ====================================================================
  green_agent_app:
    build:
      context: ../..
      dockerfile: scenarios/financial_crime/green_agent/Dockerfile
    container_name: green-agent-app
    expose:
      - "5000"
    networks:
      - agent_network
    environment:
      - SEED=${SEED:-42}
      - DIFFICULTY=${DIFFICULTY:-5}
      - GENERATE_EVIDENCE=true
      - PYTHONUNBUFFERED=1
    volumes:
      - ./green_agent/outputs:/app/outputs
      - ./green_agent/data:/app/data
    healthcheck:
      test: [ "CMD", "python", "-c", "import requests; requests.get('http://127.0.0.1:5000/health')" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    command: >
      python main.py serve --host 127.0.0.1 --port 5000 --generate-on-startup --seed ${SEED:-42} --difficulty ${DIFFICULTY:-5} --output-dir /app/outputs

  # ====================================================================
  # RUST SIDECAR: High-Performance Proxy (EXTERNAL)
  # ====================================================================
  green_agent_sidecar:
    build:
      context: ./green_agent/sidecar
      dockerfile: Dockerfile
    container_name: green-agent-sidecar
    ports:
      - "8000:8000"
    networks:
      - agent_network
    depends_on:
      green_agent_app:
        condition: service_healthy
    environment:
      - RUST_LOG=info
      - BACKEND_URL=http://green_agent_app:5000

  # ====================================================================
  # PURPLE AGENT: Baseline Investigator
  # ====================================================================
  purple_agent:
    build:
      context: ../../purple_agent
      dockerfile: Dockerfile
    container_name: purple-agent-baseline
    networks:
      - agent_network
    depends_on:
      - green_agent_sidecar
    environment:
      - GREEN_AGENT_URL=http://green_agent_sidecar:8000
      - PARTICIPANT_ID=${PARTICIPANT_ID:-baseline_purple_agent}
      - PYTHONUNBUFFERED=1
    command: [ "--green-url", "http://green_agent_sidecar:8000", "--participant-id", "${PARTICIPANT_ID:-baseline_purple_agent}", "--nodes", "0", "42", "100" ]
    restart: "no"

networks:
  agent_network:
    driver: bridge
    name: panopticon-network-rust
